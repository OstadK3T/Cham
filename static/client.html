<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cham Lobby</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        margin: 0;
        padding: 2rem;
      }
      .card {
        max-width: 720px;
        margin: 0 auto;
        background: #111827;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.6);
      }
      h1,
      h2,
      h3 {
        margin-top: 0;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
      }
      input,
      textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid #334155;
        background: #0f172a;
        color: #e2e8f0;
      }
      textarea {
        resize: none;
        min-height: 90px;
      }
      button {
        margin-top: 1rem;
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: none;
        background: #38bdf8;
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary {
        background: #1f2937;
        color: #e2e8f0;
      }
      button:disabled {
        background: #475569;
        cursor: not-allowed;
      }
      .status {
        margin-top: 1rem;
        font-size: 0.95rem;
      }
      .error {
        color: #f87171;
      }
      .hidden {
        display: none;
      }
      .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        padding: 0.4rem 0;
        border-bottom: 1px solid #1f2937;
      }
      .chat {
        margin-top: 2rem;
      }
      .chat-log {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 320px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      .chat-bubble {
        background: #1f2937;
        border-radius: 16px;
        padding: 0.6rem 0.9rem;
        max-width: 80%;
        width: fit-content;
      }
      .chat-bubble.admin {
        background: #1d4ed8;
      }
      .chat-bubble.system {
        background: #334155;
        font-style: italic;
      }
      .chat-meta {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-bottom: 0.2rem;
      }
      .chat-message {
        white-space: pre-wrap;
      }
      .chat-input {
        margin-top: 1rem;
      }
      .logs {
        max-height: 240px;
        overflow-y: auto;
        padding-right: 0.5rem;
        font-size: 0.9rem;
        color: #cbd5f5;
      }
      .badge {
        display: inline-block;
        background: #2563eb;
        color: #e2e8f0;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-size: 0.7rem;
        margin-left: 0.4rem;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <section id="login-screen">
        <h1>Cham Lobby</h1>
        <p>Pick how you want to join.</p>
        <div class="grid">
          <div>
            <h3>User login</h3>
            <label for="user-name">Your name</label>
            <input id="user-name" type="text" placeholder="Enter a name" />
            <button id="join-user">Join as user</button>
          </div>
          <div>
            <h3>Admin login</h3>
            <label for="admin-name">Admin name</label>
            <input id="admin-name" type="text" placeholder="Admin display name" />
            <label for="admin-password">Admin password</label>
            <input id="admin-password" type="password" placeholder="Password" />
            <button id="join-admin" class="secondary">Join as admin</button>
          </div>
        </div>
        <div class="status" id="status">Not connected.</div>
      </section>

      <section id="lobby-screen" class="hidden">
        <h2>Lobby <span id="role-badge" class="badge hidden"></span></h2>
        <div class="grid">
          <div>
            <h3>Online users</h3>
            <ul id="user-list"></ul>
          </div>
          <div id="admin-panel" class="hidden">
            <h3>Admin logs</h3>
            <div class="logs" id="log-list"></div>
          </div>
        </div>

        <div class="chat">
          <h3>Chat</h3>
          <div class="chat-log" id="chat-log"></div>
          <div class="chat-input">
            <label for="chat-message">Message</label>
            <textarea id="chat-message" placeholder="Write a message... (Shift + Enter for new line)"></textarea>
            <button id="send-message">Send message</button>
          </div>
        </div>
      </section>
    </div>

    <script>
      const joinUserButton = document.getElementById("join-user");
      const joinAdminButton = document.getElementById("join-admin");
      const statusEl = document.getElementById("status");
      const loginScreen = document.getElementById("login-screen");
      const lobbyScreen = document.getElementById("lobby-screen");
      const userList = document.getElementById("user-list");
      const adminPanel = document.getElementById("admin-panel");
      const logList = document.getElementById("log-list");
      const chatLog = document.getElementById("chat-log");
      const chatMessage = document.getElementById("chat-message");
      const sendMessageButton = document.getElementById("send-message");
      const roleBadge = document.getElementById("role-badge");

      let socket;
      let currentRole = "user";

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", isError);
      }

      function renderUsers(users) {
        userList.innerHTML = "";
        users.forEach((user) => {
          const li = document.createElement("li");
          const roleLabel = user.role === "admin" ? " (admin)" : "";
          li.textContent = `${user.name}${roleLabel}`;
          userList.appendChild(li);
        });
      }

      function renderLogs(logs) {
        logList.innerHTML = "";
        logs.forEach((entry) => {
          const line = document.createElement("div");
          line.textContent = `${entry.timestamp} - ${entry.message}`;
          logList.appendChild(line);
        });
        logList.scrollTop = logList.scrollHeight;
      }

      function appendChatMessage(payload) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("chat-bubble");
        if (payload.role === "admin") {
          wrapper.classList.add("admin");
        }
        if (payload.role === "system") {
          wrapper.classList.add("system");
        }

        const meta = document.createElement("div");
        meta.classList.add("chat-meta");
        meta.textContent = `${payload.name} â€¢ ${payload.timestamp}`;

        const message = document.createElement("div");
        message.classList.add("chat-message");
        message.textContent = payload.message;

        wrapper.appendChild(meta);
        wrapper.appendChild(message);
        chatLog.appendChild(wrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function openLobby(role, users, logs) {
        currentRole = role;
        loginScreen.classList.add("hidden");
        lobbyScreen.classList.remove("hidden");
        roleBadge.textContent = role === "admin" ? "Admin" : "User";
        roleBadge.classList.remove("hidden");
        renderUsers(users || []);
        if (role === "admin") {
          adminPanel.classList.remove("hidden");
          renderLogs(logs || []);
        }
      }

      function connect(payload) {
        setStatus("Connecting...");
        joinUserButton.disabled = true;
        joinAdminButton.disabled = true;

        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socketUrl = `${protocol}://${window.location.host}/ws`;
        socket = new WebSocket(socketUrl);

        socket.addEventListener("open", () => {
          socket.send(JSON.stringify(payload));
        });

        socket.addEventListener("message", (event) => {
          const messagePayload = JSON.parse(event.data);
          if (messagePayload.type === "error") {
            setStatus(messagePayload.message, true);
            joinUserButton.disabled = false;
            joinAdminButton.disabled = false;
            socket.close();
            return;
          }
          if (messagePayload.type === "join_ack") {
            setStatus("Connected!", false);
            openLobby(messagePayload.role, messagePayload.users, messagePayload.logs);
          }
          if (messagePayload.type === "users") {
            renderUsers(messagePayload.users || []);
          }
          if (messagePayload.type === "logs" && currentRole === "admin") {
            renderLogs(messagePayload.logs || []);
          }
          if (messagePayload.type === "chat") {
            appendChatMessage(messagePayload);
          }
        });

        socket.addEventListener("close", () => {
          setStatus("Disconnected from server.", true);
        });

        socket.addEventListener("error", () => {
          setStatus("Connection error.", true);
        });
      }

      function handleUserJoin() {
        const name = document.getElementById("user-name").value.trim();
        if (!name) {
          setStatus("Please enter a name.", true);
          return;
        }
        connect({ type: "join", name, role: "user" });
      }

      function handleAdminJoin() {
        const name = document.getElementById("admin-name").value.trim();
        const password = document.getElementById("admin-password").value.trim();
        if (!name) {
          setStatus("Please enter an admin name.", true);
          return;
        }
        if (!password) {
          setStatus("Please enter the admin password.", true);
          return;
        }
        connect({ type: "join", name, role: "admin", password });
      }

      function sendChatMessage() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          setStatus("Not connected.", true);
          return;
        }
        const message = chatMessage.value;
        if (!message.trim()) {
          return;
        }
        socket.send(JSON.stringify({ type: "chat", message }));
        chatMessage.value = "";
      }

      joinUserButton.addEventListener("click", handleUserJoin);
      joinAdminButton.addEventListener("click", handleAdminJoin);
      sendMessageButton.addEventListener("click", sendChatMessage);
      chatMessage.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendChatMessage();
        }
      });
    </script>
  </body>
</html>
