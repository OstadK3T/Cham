<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cham Lobby</title>
    <style>
      :root {
        color-scheme: dark;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827, #0b1120 45%, #020617 100%);
        color: #e2e8f0;
        margin: 0;
        padding: 2rem;
      }
      .card {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        backdrop-filter: blur(18px);
      }
      h1,
      h2,
      h3,
      h4 {
        margin-top: 0;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #cbd5f5;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid #334155;
        background: #0f172a;
        color: #e2e8f0;
      }
      textarea {
        resize: none;
        min-height: 90px;
      }
      button {
        margin-top: 1rem;
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        color: #0f172a;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      button.secondary {
        background: #1f2937;
        color: #e2e8f0;
      }
      button:disabled {
        background: #475569;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(56, 189, 248, 0.2);
      }
      .status {
        margin-top: 1rem;
        font-size: 0.95rem;
      }
      .error {
        color: #f87171;
      }
      .hidden {
        display: none;
      }
      .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .panel {
        background: #111827;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      li {
        padding: 0.4rem 0;
        border-bottom: 1px solid #1f2937;
      }
      .chat {
        margin-top: 2rem;
      }
      .chat-log {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 320px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      .chat-bubble {
        background: #1f2937;
        border-radius: 16px;
        padding: 0.6rem 0.9rem;
        max-width: 80%;
        width: fit-content;
        animation: fadeIn 0.25s ease;
      }
      .chat-bubble.admin {
        background: #1d4ed8;
      }
      .chat-bubble.system {
        background: #334155;
        font-style: italic;
      }
      .chat-meta {
        font-size: 0.75rem;
        color: #cbd5f5;
        margin-bottom: 0.2rem;
      }
      .chat-message {
        white-space: pre-wrap;
      }
      .chat-input {
        margin-top: 1rem;
      }
      .logs {
        max-height: 220px;
        overflow-y: auto;
        padding-right: 0.5rem;
        font-size: 0.9rem;
        color: #cbd5f5;
      }
      .badge {
        display: inline-block;
        background: #2563eb;
        color: #e2e8f0;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-size: 0.7rem;
        margin-left: 0.4rem;
      }
      .music-controls {
        display: grid;
        gap: 0.75rem;
      }
      .music-row {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: 1fr auto;
        align-items: center;
      }
      .playlist-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.4rem 0;
        border-bottom: 1px solid #1f2937;
      }
      .playlist-actions button {
        margin: 0;
        width: auto;
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
      }
      .slider {
        width: 100%;
      }
      .timeline {
        display: grid;
        gap: 0.5rem;
      }
      .timeline-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #94a3b8;
      }
      .channel-list {
        display: grid;
        gap: 0.75rem;
      }
      .channel-card {
        background: #0f172a;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .channel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
      .channel-users {
        display: grid;
        gap: 0.35rem;
      }
      .user-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #3b82f6;
      }
      .status-dot.talking {
        background: #22c55e;
      }
      .status-dot.radio {
        background: #f97316;
      }
      .ptt-row {
        display: grid;
        gap: 0.75rem;
      }
      .ptt-button {
        background: linear-gradient(135deg, #22c55e, #14b8a6);
      }
      .ptt-button.active {
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <section id="login-screen">
        <h1>Cham Lobby</h1>
        <p>Pick how you want to join.</p>
        <div class="grid">
          <div class="panel">
            <h3>User login</h3>
            <label for="user-name">Your name</label>
            <input id="user-name" type="text" placeholder="Enter a name" />
            <button id="join-user">Join as user</button>
          </div>
          <div class="panel">
            <h3>Admin login</h3>
            <label for="admin-name">Admin name</label>
            <input id="admin-name" type="text" placeholder="Admin display name" />
            <label for="admin-password">Admin password</label>
            <input id="admin-password" type="password" placeholder="Password" />
            <button id="join-admin" class="secondary">Join as admin</button>
          </div>
        </div>
        <div class="status" id="status">Not connected.</div>
      </section>

      <section id="lobby-screen" class="hidden">
        <h2>Lobby <span id="role-badge" class="badge hidden"></span></h2>
        <div class="grid">
          <div class="panel">
            <h3>Online users</h3>
            <ul id="user-list"></ul>
          </div>
          <div id="admin-panel" class="panel hidden">
            <h3>Admin logs</h3>
            <div class="logs" id="log-list"></div>
          </div>
        </div>

        <div class="grid" style="margin-top: 1.5rem">
          <div class="panel">
            <h3>Voice channels</h3>
            <div class="channel-list" id="channel-list"></div>
            <button id="leave-channel" class="secondary">Leave channel</button>
          </div>
          <div class="panel">
            <h3>Push to talk</h3>
            <div class="ptt-row">
              <label for="ptt-key">PTT key binding</label>
              <select id="ptt-key">
                <option value="v">V</option>
                <option value="b">B</option>
                <option value="space">Space</option>
              </select>
              <button id="ptt-button" class="ptt-button">Hold to talk</button>
            </div>
            <div class="ptt-row" style="margin-top: 1rem">
              <h4>Microphone</h4>
              <button id="mic-permission" class="secondary">Enable microphone</button>
              <label for="mic-select">Input device</label>
              <select id="mic-select"></select>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top: 1.5rem">
          <div class="panel" id="radio-panel">
            <h3>Radio channel</h3>
            <div class="timeline">
              <input id="timeline" type="range" min="0" max="0" value="0" class="slider" disabled />
              <div class="timeline-labels">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
              </div>
            </div>
            <div style="margin-top: 1rem">
              <h4>Playlist</h4>
              <div id="playlist"></div>
            </div>
          </div>
          <div class="panel chat">
            <h3>Chat</h3>
            <div class="chat-log" id="chat-log"></div>
            <div class="chat-input">
              <label for="chat-message">Message</label>
              <textarea
                id="chat-message"
                placeholder="Write a message... (Shift + Enter for new line)"
              ></textarea>
              <button id="send-message">Send message</button>
            </div>
          </div>
        </div>

        <div id="music-admin" class="panel hidden" style="margin-top: 1.5rem">
          <h3>Radio admin controls</h3>
          <div class="music-controls" id="music-controls">
            <div class="music-row">
              <input id="track-url" type="text" placeholder="Paste .mp3 link" />
              <button id="add-track" class="secondary">Add</button>
            </div>
            <label for="track-title">Track title (optional)</label>
            <input id="track-title" type="text" placeholder="Name shown in playlist" />
            <div class="music-row">
              <button id="play-track">Play</button>
              <button id="pause-track" class="secondary">Pause</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <audio id="audio-player"></audio>

    <script>
      const joinUserButton = document.getElementById("join-user");
      const joinAdminButton = document.getElementById("join-admin");
      const statusEl = document.getElementById("status");
      const loginScreen = document.getElementById("login-screen");
      const lobbyScreen = document.getElementById("lobby-screen");
      const userList = document.getElementById("user-list");
      const adminPanel = document.getElementById("admin-panel");
      const logList = document.getElementById("log-list");
      const chatLog = document.getElementById("chat-log");
      const chatMessage = document.getElementById("chat-message");
      const sendMessageButton = document.getElementById("send-message");
      const roleBadge = document.getElementById("role-badge");
      const trackUrlInput = document.getElementById("track-url");
      const trackTitleInput = document.getElementById("track-title");
      const addTrackButton = document.getElementById("add-track");
      const playButton = document.getElementById("play-track");
      const pauseButton = document.getElementById("pause-track");
      const playlistEl = document.getElementById("playlist");
      const timeline = document.getElementById("timeline");
      const currentTimeLabel = document.getElementById("current-time");
      const durationLabel = document.getElementById("duration");
      const audioPlayer = document.getElementById("audio-player");
      const channelList = document.getElementById("channel-list");
      const leaveChannelButton = document.getElementById("leave-channel");
      const pttButton = document.getElementById("ptt-button");
      const pttKeySelect = document.getElementById("ptt-key");
      const micPermissionButton = document.getElementById("mic-permission");
      const micSelect = document.getElementById("mic-select");
      const musicAdminPanel = document.getElementById("music-admin");

      const voiceChannels = ["Voice 1", "Voice 2", "Voice 3", "Voice 4", "Radio Channel"];

      let socket;
      let currentRole = "user";
      let currentUserName = "";
      let currentChannel = null;
      let isTalking = false;
      let pttKey = "v";
      let localStream = null;
      let peerConnections = new Map();
      let remoteAudio = new Map();

      let musicState = {
        queue: [],
        current_track_id: null,
        is_playing: false,
        position: 0,
        server_time: 0,
      };
      let syncTimer;

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", isError);
      }

      function renderUsers(users) {
        userList.innerHTML = "";
        users.forEach((user) => {
          const li = document.createElement("li");
          const roleLabel = user.role === "admin" ? " (admin)" : "";
          li.textContent = `${user.name}${roleLabel}`;
          userList.appendChild(li);
        });
      }

      function renderLogs(logs) {
        logList.innerHTML = "";
        logs.forEach((entry) => {
          const line = document.createElement("div");
          line.textContent = `${entry.timestamp} - ${entry.message}`;
          logList.appendChild(line);
        });
        logList.scrollTop = logList.scrollHeight;
      }

      function appendChatMessage(payload) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("chat-bubble");
        if (payload.role === "admin") {
          wrapper.classList.add("admin");
        }
        if (payload.role === "system") {
          wrapper.classList.add("system");
        }

        const meta = document.createElement("div");
        meta.classList.add("chat-meta");
        meta.textContent = `${payload.name} â€¢ ${payload.timestamp}`;

        const message = document.createElement("div");
        message.classList.add("chat-message");
        message.textContent = payload.message;

        wrapper.appendChild(meta);
        wrapper.appendChild(message);
        chatLog.appendChild(wrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function openLobby(role, users, logs) {
        currentRole = role;
        loginScreen.classList.add("hidden");
        lobbyScreen.classList.remove("hidden");
        roleBadge.textContent = role === "admin" ? "Admin" : "User";
        roleBadge.classList.remove("hidden");
        renderUsers(users || []);
        if (role === "admin") {
          adminPanel.classList.remove("hidden");
          musicAdminPanel.classList.remove("hidden");
          renderLogs(logs || []);
        }
      }

      function connect(payload) {
        setStatus("Connecting...");
        joinUserButton.disabled = true;
        joinAdminButton.disabled = true;

        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socketUrl = `${protocol}://${window.location.host}/ws`;
        socket = new WebSocket(socketUrl);

        socket.addEventListener("open", () => {
          socket.send(JSON.stringify(payload));
        });

        socket.addEventListener("message", (event) => {
          const messagePayload = JSON.parse(event.data);
          if (messagePayload.type === "error") {
            setStatus(messagePayload.message, true);
            joinUserButton.disabled = false;
            joinAdminButton.disabled = false;
            socket.close();
            return;
          }
          if (messagePayload.type === "join_ack") {
            setStatus("Connected!", false);
            openLobby(messagePayload.role, messagePayload.users, messagePayload.logs);
            updateMusicState(messagePayload);
            updateVoiceState(messagePayload);
          }
          if (messagePayload.type === "users") {
            renderUsers(messagePayload.users || []);
          }
          if (messagePayload.type === "logs" && currentRole === "admin") {
            renderLogs(messagePayload.logs || []);
          }
          if (messagePayload.type === "chat") {
            appendChatMessage(messagePayload);
          }
          if (messagePayload.type === "music_state") {
            updateMusicState(messagePayload);
          }
          if (messagePayload.type === "voice_state") {
            updateVoiceState(messagePayload);
          }
          if (messagePayload.type === "voice_offer") {
            handleOffer(messagePayload.from, messagePayload.data);
          }
          if (messagePayload.type === "voice_answer") {
            handleAnswer(messagePayload.from, messagePayload.data);
          }
          if (messagePayload.type === "voice_ice") {
            handleIce(messagePayload.from, messagePayload.data);
          }
        });

        socket.addEventListener("close", () => {
          setStatus("Disconnected from server.", true);
          stopSyncTimer();
          cleanupVoice();
        });

        socket.addEventListener("error", () => {
          setStatus("Connection error.", true);
        });
      }

      function handleUserJoin() {
        const name = document.getElementById("user-name").value.trim();
        if (!name) {
          setStatus("Please enter a name.", true);
          return;
        }
        currentUserName = name;
        connect({ type: "join", name, role: "user" });
      }

      function handleAdminJoin() {
        const name = document.getElementById("admin-name").value.trim();
        const password = document.getElementById("admin-password").value.trim();
        if (!name) {
          setStatus("Please enter an admin name.", true);
          return;
        }
        if (!password) {
          setStatus("Please enter the admin password.", true);
          return;
        }
        currentUserName = name;
        connect({ type: "join", name, role: "admin", password });
      }

      function sendChatMessage() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          setStatus("Not connected.", true);
          return;
        }
        const message = chatMessage.value;
        if (!message.trim()) {
          return;
        }
        socket.send(JSON.stringify({ type: "chat", message }));
        chatMessage.value = "";
      }

      function sendMusicCommand(payload) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          setStatus("Not connected.", true);
          return;
        }
        socket.send(JSON.stringify(payload));
      }

      function sendVoiceCommand(payload) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          setStatus("Not connected.", true);
          return;
        }
        socket.send(JSON.stringify(payload));
      }

      function formatTime(seconds) {
        const safe = Math.max(0, Math.floor(seconds));
        const mins = Math.floor(safe / 60);
        const secs = safe % 60;
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      function renderPlaylist() {
        playlistEl.innerHTML = "";
        musicState.queue.forEach((track) => {
          const row = document.createElement("div");
          row.classList.add("playlist-item");
          const name = document.createElement("span");
          name.textContent = track.title;
          row.appendChild(name);

          const actions = document.createElement("div");
          actions.classList.add("playlist-actions");

          if (currentRole === "admin") {
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", () => {
              sendMusicCommand({ type: "music_delete", track_id: track.track_id });
            });
            actions.appendChild(deleteButton);
          }

          row.appendChild(actions);
          playlistEl.appendChild(row);
        });
      }

      function updateAudioPlayer() {
        const activeTrack = musicState.queue.find(
          (track) => track.track_id === musicState.current_track_id
        );
        const shouldListen = currentChannel === "Radio Channel";

        if (!activeTrack) {
          audioPlayer.pause();
          audioPlayer.removeAttribute("src");
          audioPlayer.load();
          timeline.max = 0;
          timeline.value = 0;
          currentTimeLabel.textContent = "0:00";
          durationLabel.textContent = "0:00";
          playButton.disabled = musicState.is_playing;
          pauseButton.disabled = !musicState.is_playing;
          return;
        }

        if (audioPlayer.src !== activeTrack.url) {
          audioPlayer.src = activeTrack.url;
        }

        const desiredPosition = musicState.position || 0;
        if (Number.isFinite(desiredPosition)) {
          if (Math.abs(audioPlayer.currentTime - desiredPosition) > 0.5) {
            audioPlayer.currentTime = desiredPosition;
          }
        }

        if (musicState.is_playing && shouldListen) {
          if (audioPlayer.paused) {
            const playPromise = audioPlayer.play();
            if (playPromise) {
              playPromise.catch(() => {});
            }
          }
        } else {
          audioPlayer.pause();
        }

        playButton.disabled = musicState.is_playing;
        pauseButton.disabled = !musicState.is_playing;
      }

      function updateTimelineUI() {
        const duration = Number.isFinite(audioPlayer.duration) ? audioPlayer.duration : 0;
        timeline.max = duration ? duration : 0;
        durationLabel.textContent = formatTime(duration);

        const shouldListen = currentChannel === "Radio Channel";
        if (musicState.is_playing && shouldListen) {
          timeline.value = audioPlayer.currentTime;
          currentTimeLabel.textContent = formatTime(audioPlayer.currentTime);
        } else {
          timeline.value = musicState.position || 0;
          currentTimeLabel.textContent = formatTime(musicState.position || 0);
        }
      }

      function updateMusicState(payload) {
        musicState = {
          queue: payload.queue || [],
          current_track_id: payload.current_track_id,
          is_playing: payload.is_playing,
          position: payload.position || 0,
          server_time: payload.server_time || 0,
        };
        renderPlaylist();
        updateAudioPlayer();
        updateTimelineUI();
        startSyncTimer();
      }

      function startSyncTimer() {
        stopSyncTimer();
        syncTimer = setInterval(() => {
          updateTimelineUI();
        }, 500);
      }

      function stopSyncTimer() {
        if (syncTimer) {
          clearInterval(syncTimer);
          syncTimer = null;
        }
      }

      function updateVoiceState(payload) {
        const channels = payload.channels || {};
        const talking = payload.talking || {};
        channelList.innerHTML = "";

        voiceChannels.forEach((channelName) => {
          const users = channels[channelName] || [];
          const card = document.createElement("div");
          card.classList.add("channel-card");

          const header = document.createElement("div");
          header.classList.add("channel-header");

          const title = document.createElement("span");
          title.textContent = channelName;
          header.appendChild(title);

          const joinButton = document.createElement("button");
          joinButton.textContent = currentChannel === channelName ? "Joined" : "Join";
          joinButton.classList.add("secondary");
          joinButton.disabled = currentChannel === channelName;
          joinButton.addEventListener("click", () => {
            joinVoiceChannel(channelName);
          });
          header.appendChild(joinButton);

          card.appendChild(header);

          const list = document.createElement("div");
          list.classList.add("channel-users");
          if (channelName === "Radio Channel") {
            const bot = document.createElement("div");
            bot.classList.add("user-pill");
            const dot = document.createElement("span");
            dot.classList.add("status-dot", "radio");
            bot.appendChild(dot);
            const label = document.createElement("span");
            label.textContent = "Radio Bot";
            bot.appendChild(label);
            list.appendChild(bot);
          }
          users.forEach((userName) => {
            const row = document.createElement("div");
            row.classList.add("user-pill");
            const dot = document.createElement("span");
            dot.classList.add("status-dot");
            if (talking[userName]) {
              dot.classList.add("talking");
            }
            row.appendChild(dot);
            const label = document.createElement("span");
            label.textContent = userName;
            row.appendChild(label);
            list.appendChild(row);
          });
          card.appendChild(list);
          channelList.appendChild(card);
        });

        currentChannel = Object.keys(channels).find((channel) =>
          (channels[channel] || []).includes(currentUserName)
        ) || null;

        updateAudioPlayer();
        syncPeers(channels);
      }

      function joinVoiceChannel(channelName) {
        currentChannel = channelName;
        sendVoiceCommand({ type: "voice_join", channel: channelName });
      }

      function leaveVoiceChannel() {
        currentChannel = null;
        sendVoiceCommand({ type: "voice_leave" });
        stopTalking();
      }

      async function requestMicrophone(deviceId = null) {
        try {
          const constraints = {
            audio: deviceId ? { deviceId: { exact: deviceId } } : true,
            video: false,
          };
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          localStream.getAudioTracks().forEach((track) => {
            track.enabled = false;
          });
          await refreshMicDevices();
          await rebuildConnections();
        } catch (error) {
          setStatus("Microphone permission denied.", true);
        }
      }

      async function refreshMicDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const inputs = devices.filter((device) => device.kind === "audioinput");
        micSelect.innerHTML = "";
        inputs.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.textContent = device.label || `Microphone ${micSelect.length + 1}`;
          micSelect.appendChild(option);
        });
      }

      function startTalking() {
        if (!localStream || !currentChannel) {
          return;
        }
        if (isTalking) {
          return;
        }
        isTalking = true;
        localStream.getAudioTracks().forEach((track) => {
          track.enabled = true;
        });
        pttButton.classList.add("active");
        sendVoiceCommand({ type: "voice_talking", is_talking: true });
      }

      function stopTalking() {
        if (!localStream) {
          return;
        }
        if (!isTalking) {
          return;
        }
        isTalking = false;
        localStream.getAudioTracks().forEach((track) => {
          track.enabled = false;
        });
        pttButton.classList.remove("active");
        sendVoiceCommand({ type: "voice_talking", is_talking: false });
      }

      function handleKeyDown(event) {
        const key = event.key.toLowerCase();
        if ((pttKey === "space" && event.code === "Space") || key === pttKey) {
          startTalking();
        }
      }

      function handleKeyUp(event) {
        const key = event.key.toLowerCase();
        if ((pttKey === "space" && event.code === "Space") || key === pttKey) {
          stopTalking();
        }
      }

      function buildPeerConnection(peerName) {
        const connection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        if (localStream) {
          localStream.getTracks().forEach((track) => {
            connection.addTrack(track, localStream);
          });
        }

        connection.onicecandidate = (event) => {
          if (event.candidate) {
            sendVoiceCommand({ type: "voice_ice", target: peerName, data: event.candidate });
          }
        };

        connection.ontrack = (event) => {
          if (remoteAudio.has(peerName)) {
            return;
          }
          const audio = document.createElement("audio");
          audio.autoplay = true;
          audio.srcObject = event.streams[0];
          remoteAudio.set(peerName, audio);
        };

        peerConnections.set(peerName, connection);
        return connection;
      }

      async function createOffer(peerName) {
        const connection = peerConnections.get(peerName) || buildPeerConnection(peerName);
        const offer = await connection.createOffer();
        await connection.setLocalDescription(offer);
        sendVoiceCommand({ type: "voice_offer", target: peerName, data: offer });
      }

      async function handleOffer(peerName, offer) {
        const connection = peerConnections.get(peerName) || buildPeerConnection(peerName);
        await connection.setRemoteDescription(offer);
        const answer = await connection.createAnswer();
        await connection.setLocalDescription(answer);
        sendVoiceCommand({ type: "voice_answer", target: peerName, data: answer });
      }

      async function handleAnswer(peerName, answer) {
        const connection = peerConnections.get(peerName);
        if (!connection) {
          return;
        }
        await connection.setRemoteDescription(answer);
      }

      async function handleIce(peerName, candidate) {
        const connection = peerConnections.get(peerName);
        if (!connection || !candidate) {
          return;
        }
        await connection.addIceCandidate(candidate);
      }

      function syncPeers(channels) {
        if (!currentChannel) {
          cleanupVoice();
          return;
        }
        const usersInChannel = channels[currentChannel] || [];
        const peers = usersInChannel.filter((name) => name !== currentUserName);

        peers.forEach((peerName) => {
          if (!peerConnections.has(peerName)) {
            buildPeerConnection(peerName);
            if (currentUserName < peerName) {
              createOffer(peerName);
            }
          }
        });

        [...peerConnections.keys()].forEach((peerName) => {
          if (!peers.includes(peerName)) {
            closePeer(peerName);
          }
        });
      }

      async function rebuildConnections() {
        const peers = [...peerConnections.keys()];
        peers.forEach((peerName) => closePeer(peerName));
      }

      function closePeer(peerName) {
        const connection = peerConnections.get(peerName);
        if (connection) {
          connection.close();
        }
        peerConnections.delete(peerName);
        const audio = remoteAudio.get(peerName);
        if (audio) {
          audio.srcObject = null;
        }
        remoteAudio.delete(peerName);
      }

      function cleanupVoice() {
        [...peerConnections.keys()].forEach((peerName) => closePeer(peerName));
        stopTalking();
      }

      joinUserButton.addEventListener("click", handleUserJoin);
      joinAdminButton.addEventListener("click", handleAdminJoin);
      sendMessageButton.addEventListener("click", sendChatMessage);
      chatMessage.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendChatMessage();
        }
      });

      addTrackButton.addEventListener("click", () => {
        const url = trackUrlInput.value.trim();
        const title = trackTitleInput.value.trim();
        if (!url) {
          setStatus("Please provide an mp3 link.", true);
          return;
        }
        sendMusicCommand({ type: "music_add", url, title });
        trackUrlInput.value = "";
        trackTitleInput.value = "";
      });

      playButton.addEventListener("click", () => {
        sendMusicCommand({ type: "music_play" });
      });

      pauseButton.addEventListener("click", () => {
        sendMusicCommand({ type: "music_pause" });
      });

      leaveChannelButton.addEventListener("click", leaveVoiceChannel);

      pttButton.addEventListener("mousedown", startTalking);
      pttButton.addEventListener("mouseup", stopTalking);
      pttButton.addEventListener("mouseleave", stopTalking);

      pttKeySelect.addEventListener("change", (event) => {
        pttKey = event.target.value;
      });

      micPermissionButton.addEventListener("click", () => {
        requestMicrophone();
      });

      micSelect.addEventListener("change", (event) => {
        requestMicrophone(event.target.value);
      });

      window.addEventListener("keydown", handleKeyDown);
      window.addEventListener("keyup", handleKeyUp);

      audioPlayer.addEventListener("loadedmetadata", updateTimelineUI);
      audioPlayer.addEventListener("timeupdate", updateTimelineUI);
    </script>
  </body>
</html>
